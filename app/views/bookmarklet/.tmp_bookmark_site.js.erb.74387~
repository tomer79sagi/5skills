<%= render :partial => '/bookmarklet/bl_header' %>

	<% # Load %>
	
	<% if @state && (@state == 1 || @state == 4) # Initial behavior %>
	
		<% if session[:user] %>
			$('#logged_in_details').replaceWith("<b><%= session[:user].first_name %> <%= session[:user].last_name %></b>\
				, <i><a id='btn_logout' href=\"/\" onClick=\"ajax_it('logout'); return false;\">Logout</a></i>");
			$('#logged_in_bar').show();
		<% end %>
		
		<% if @state == 4 %>
		
			$('#primary_messages').replaceWith("<div id='primary_messages'>Site already exists!\
				<input type='hidden' id='role_application_id' value='<%= @role_application.id %>'></div>");
			
			<% if @role_application %>
				$('#primary_messages').append("&nbsp;&nbsp;\
					<i>You can update its details below</i>");
			<% end %>
			
		<% elsif @is_success %>
		
			$('#primary_messages').replaceWith("<div id='primary_messages'>Logged in successfully</div>");
			
		<% end %>
	
		$('#content_panel').replaceWith("\
			<div id='content_panel'>\
				\
				<div id='site_parsing_panel' style='padding:.5em 0em .5em 0em;'>\
					<table>\
						<tr>\
							<td style='text-align:left;height:20px;'>Site detected: </td>\
							<td id='site_detected' style='text-align:left;height:20px;vertical-aling:top;'>\
								<b><%= @site_detected %></b>\
							</td>\
						</tr>\
						<tr>\
							<td style='text-align:left;height:20px;vertical-align:top;'>Page type: </td>\
							<td id='site_detected' style='text-align:left;height:20px;vertical-align:bottom;'>\
								<select id=\"page_type\" style=\"vertical-align:bottom;\">\
									<option value=\"0\">- Unknown- </option>\
									<option value=\"1\">Search results</option>\
									<option value=\"2\" selected=\"true\">Job ad</option>\
									<option value=\"3\">Apply page</option>\
								</select>\
							</td>\
						</tr>\
					</table>\
				</div>\
				\
				<hr/>\
				\
				<div id='content_panel_messages'></div>\
				\
				<p><b><u>Job Details</u></b></p>\
				\
				<table>\
					<tr>\
						<td style=\"vertical-align:top;\"><b>Title</b>:</td>\
						<td style=\"vertical-align:top;\"><button id=\"btn_copy_title\" style=\"width:20px;height:20px;vertical-align:middle;\" onClick=\"ajax_it('copy_selection', $('#title')); return false;\">></button>\</td>\
						<td><input id=\"title\" type=\"text\" size=\"40\" value=\"<%= @role_application.role.title if @role_application && @role_application && @role_application.role %>\"></td>\
					</tr>\
					<tr>\
						<td></td>\
						<td></td>\
						<td id='title_error' style='font-size:10pt;'></td>\
					</tr>\
					<tr>\
						<td style=\"vertical-align:top;\">Company / Agency:</td>\
						<td style=\"vertical-align:top;\"><button id=\"btn_copy_organisation\" style=\"width:20px;height:20px;vertical-align:middle;\" onClick=\"ajax_it('copy_selection', $('#organisation')); return false;\">></button>\</td>\
						<td>\
							<input id=\"organisation\" type=\"text\" value=\"\" style=\"width:100px;\">\
							&nbsp;type:&nbsp;\
							<select id=\"organisation_type\">\
								<option value=\"0\">- N/A -</option>\
								<option value=\"1\">Company</option>\
								<option value=\"2\">Agency</option>\
							</select>\
						</td>\
					</tr>\
					<tr>\
						<td></td>\
						<td></td>\
						<td id='organisation_error' style='font-size:10pt;'></td>\
					</tr>\
					<tr>\
						<td style=\"vertical-align:top;\">Salary:</td>\
						<td style=\"vertical-align:top;\"><button id=\"btn_copy_salary\" style=\"width:20px;height:20px;vertical-align:middle;\" onClick=\"ajax_it('copy_selection', $('#salary_max')); return false;\">></button>\</td>\
						<td>\
							<input id=\"salary_max\" type=\"text\" value=\"<%= @role_application.role.salary_max if @role_application && @role_application && @role_application.role %>\" style=\"width:50px;\">\
							<select id=\"salary_frequency_id\">\
								<% Role.salary_types_for_select.each do |option| %>\
									<option value=\"<%= option[1] %>\"><%= option[0] %></option>\
								<% end %>\
							</select>\
						</td>\
					</tr>\
					<tr>\
						<td></td>\
						<td></td>\
						<td id='salary_max_error' style='font-size:10pt;'></td>\
					</tr>\
					<tr>\
						<td style=\"vertical-align:top;\">Location:</td>\
						<td style=\"vertical-align:top;\"><button id=\"btn_copy_role_location\" style=\"width:20px;height:20px;vertical-align:middle;\" onClick=\"ajax_it('copy_selection', $('#role_location')); return false;\">></button>\</td>\
						<td>\
							<input id=\"role_location\" type=\"text\" style=\"width:80px;\">\
							&nbsp;or&nbsp;\
							<select id=\"page_type\" style=\"width:126px;vertical-align:bottom;\">\
								<option value=\"1\">Auckland</option>\
								<option value=\"2\" selected=\"true\">Wellington</option>\
								<option value=\"3\">Palmerston North</option>\
							</select>\
						</td>\
					</tr>\
					<tr>\
						<td></td>\
						<td></td>\
						<td id='role_location_error' style='font-size:10pt;'></td>\
					</tr>\
					<tr>\
						<td style=\"vertical-align:top;\">Description:</td>\
						<td style=\"vertical-align:top;\"><button id=\"btn_copy_description\" style=\"width:20px;height:20px;vertical-align:middle;\" onClick=\"ajax_it('copy_selection', $('#company_or_agency')); return false;\">></button>\</td>\
						<td>\
							<input id=\"organisation\" type=\"text\" value=\"\">\
							&nbsp;type:&nbsp;\
							<select id=\"organisation_type\">\
								<option value=\"0\">- N/A -</option>\
								<option value=\"1\">Company</option>\
								<option value=\"2\">Agency</option>\
							</select>\
						</td>\
					</tr>\
					<tr>\
						<td></td>\
						<td></td>\
						<td id='organisation_error' style='font-size:10pt;'></td>\
					</tr>\
				</table>\
				\
				<p><hr/></p>\
				\
				<div id='next_action_messages'></div>\
				\
				<p><b><u>Next action (with reminder)</u></b></p>\
				\
				<table>\
					<tr>\
						<td style=\"vertical-align:top;\"><b>Action</b>:</td>\
						<td>\
							<select id=\"page_type\" style=\"width:140px;vertical-align:bottom;\">\
								<option value=\"1\">Email my CV</option>\
								<option value=\"2\" selected=\"true\">Follow-up email or phone call</option>\
								<option value=\"3\">Call someone</option>\
							</select>\
							&nbsp;or&nbsp;\
							<input id=\"custom_action\" type=\"text\" style=\"width:120px;\">\
						</td>\
					</tr>\
					<tr>\
						<td style=\"vertical-align:top;\">&nbsp;<b>When</b>:</td>\
						<td>\
							<select id=\"action_day\" style=\"width:140px;vertical-align:bottom;\">\
								<% @action_day_options_arr.each_index do |option_index| %>\
									<option value=\"<%= @action_day_options_arr[option_index][1] %>\"\
										<%= ' selected=\"true\"' if option_index == 1 %>\
										><%= @action_day_options_arr[option_index][0] %></option>\
								<% end %>\
							</select>\
						</td>\
					</tr>\
					<tr>\
						<td style=\"vertical-align:top;\">&nbsp;</td>\
						<td>\
							<select id=\"timezone\" style=\"width:260px;vertical-align:bottom;\">\
								<% @timezone_options_arr.each_index do |option_index| %>\
									<option value=\"<%= @timezone_options_arr[option_index][1] %>\"\
										<%= ' selected=\"true\"' if @timezone_options_arr[option_index][1] == @selected_country_timezone %>\
										><%= @timezone_options_arr[option_index][0] %></option>\
								<% end %>\
							</select>\
						</td>\
					</tr>\
				</table>\
				\
				<p><hr/></p>\
				\
				<div id='buttons_panel' style=\"padding:.5em 0em 0em 0em;\"></div>");
		
		$('#buttons_panel').replaceWith("\
			<div id='buttons_panel' style=\"padding:.5em 0em 0em 0em;\">\
				<button id=\"btn_save\" style=\"width:50px;height:25px;z-index:1500;\" onClick=\"ajax_it('save'); return false;\">Save</button>&nbsp;\
				<button id=\"btn_save_and_close\" style=\"width:125px;height:25px;\" onClick=\"ajax_it('save_and_close'); return false;\">Save & Close</button>&nbsp;\
				<button id=\"btn_close\" style=\"width:50px;height:25px;\" onClick=\"ajax_it('close'); return false;\">Close</button>&nbsp;\
				<br/>\
				<button id=\"btn_parse_page\" style=\"width:50px;height:25px;\" onClick=\"ajax_it('parse_page'); return false;\">Parse</button>&nbsp;\
				<button id=\"btn_populate_apply_fields\" style=\"width:100px;height:25px;\" onClick=\"ajax_it('populate_apply_fields'); return false;\">Populate</button>&nbsp;\
				<button id=\"btn_move_widget\" style=\"width:100px;height:25px;\" onClick=\"ajax_it('move_widget'); return false;\">Move widget</button>&nbsp;\
				<br/>\
				<button id=\"btn_grab_job_fields\" style=\"width:125px;height:25px;\" onClick=\"ajax_it('grab_job_fields'); return false;\">Grab job fields</button>&nbsp;\
			</div>");
	
	<% elsif @state && @state == 0 # Failed, stay on current screen %>
		
		$("#content_panel_messages").attr("display", "inline");
		$("#content_panel_messages").replaceWith("<div id=\"content_panel_messages\">Errors found in this form!</div>");
		
		// Clear all error messages
		$("#title_error").replaceWith("<td id='title_error' style='font-size:8pt;'></td>");
		$("#salary_max_error").replaceWith("<td id='salary_max_error' style='font-size:8pt;'></td>");
		$("#role_location_error").replaceWith("<td id='role_location_error' style='font-size:8pt;'></td>");
				
		<% if @role.errors %>
			<% @role.errors.each do |attr, msg| %>
				$("#<%= attr %>_error").replaceWith("<td id='<%= attr %>_error' style='font-size:8pt;'>Error in this field.</td>");
			<% end %>
		<% end %>
		
	<% elsif @state && @state == 2 # Success and stay on current screen %>

		$("#content_panel_messages").attr("display", "inline");
		$("#content_panel_messages").replaceWith("<div id=\"content_panel_messages\">Form submitted successfully!</div>");
		
		// Clear all error messages
		$("#title_error").replaceWith("<td id='title_error' style='font-size:8pt;'></td>");
		$("#salary_max_error").replaceWith("<td id='salary_max_error' style='font-size:8pt;'></td>");
		$("#role_location_error").replaceWith("<td id='role_location_error' style='font-size:8pt;'></td>");
		
		// Change the labels of the buttons to 'update' mode
		$("#btn_save").text('Update');
		$("#btn_save_and_close").text('Update & Close');
		
		<% if @role_application %>
			if (!$('#buttons_panel')) {
				$('#buttons_panel').append("<br/>\
					<i><a id='btn_flyc_role' href=\"/\" onClick=\"ajax_it('flyc_role'); return false;\">See role in Flyc</a></i>");
			}
		<% end %>
		
	<% elsif @state && @state == 3 # Success and redirect %>
	
		$("#content_panel_messages").attr("display", "inline");
		$("#content_panel_messages").replaceWith("<div id=\"content_panel_messages\">Form submitted successfully!</div>");
		
		setTimeout("ajax_it('close')", 1000);
	
	<% end %>
	
		
	<% if @state && @state == 4 # Site already exists, allow update and delete options (perhaps duplicate in the future) %>
	
		$('#buttons_panel').replaceWith("\
			<div id='buttons_panel' style=\"padding:.5em 0em 0em 0em;\">\
				<button id=\"btn_save\" style=\"width:50px;height:25px;z-index:1500;\" onClick=\"ajax_it('update'); return false;\">Update</button>&nbsp;\
				<button id=\"btn_save_and_close\" style=\"width:125px;height:25px;\" onClick=\"ajax_it('update_and_close'); return false;\">Update & Close</button>&nbsp;\
				<button id=\"btn_close\" style=\"width:50px;height:25px;\" onClick=\"ajax_it('close'); return false;\">Close</button>&nbsp;\
			</div>");
			
		<% if @role_application %>
			$('#buttons_panel').append("<br/>\
				<i><a id='btn_flyc_role' href=\"/\" onClick=\"ajax_it('flyc_role'); return false;\">See role in Flyc</a></i>");
		<% end %>
		
	<% end %>
	
	// Enable the buttons
	$("#btn_save").attr('disabled', '');
	$("#btn_save_and_close").attr('disabled', '');
	$("#btn_close").attr('disabled', '');

<%= render :partial => '/bookmarklet/bl_footer' %>